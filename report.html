<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KISR QA Statistics</title>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
    }
    .main-container {
      display: flex;
      width: 100%;
    }
    #sidebar {
      width: 220px;
      background-color: #f0f0f0;
      padding: 20px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .content {
      flex-grow: 1;
      padding: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 10px;
      text-align: center;
    }
    th {
      background-color: #f5f5f5;
    }
    select, button {
      margin-right: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div id="sidebar"></div>
    <div class="content">
      <h2>KISR QA Statistics (First Occurrence by HRID)</h2>

      <label>Select Period:
        <select id="periodSelect"></select>
      </label>
      <button onclick="renderTable()">Show</button>
      <button onclick="downloadPDF()">Download PDF</button>

      <table id="statsTable">
        <thead>
          <tr>
            <th>Period</th>
            <th>Initial QA - OK</th>
            <th>Initial QA - Rejected</th>
            <th>Final QA - OK</th>
            <th>Final QA - Rejected</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
  // Load sidebar
  fetch('sidebar.html')
    .then(res => res.text())
    .then(html => document.getElementById('sidebar').innerHTML = html);

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAvwfziFOkb-j0Hbc7Ff-MOBfxpNs7q2TI",
    authDomain: "kisr-qa-dashboard.firebaseapp.com",
    projectId: "kisr-qa-dashboard"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let statsResult = {}; // store all periods data

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "index.html";
    } else {
      generateStats(); // load all data on start
    }
  });

  function getSixMonthPeriod(date) {
    const d = new Date(date);
    const year = d.getFullYear();
    const month = d.getMonth();
    return month >= 9
      ? `${year}-Oct to ${year + 1}-Mar`
      : `${year - 1}-Oct to ${year}-Mar`;
  }

  async function generateStats() {
    statsResult = {};
    const collections = ["initial_checks", "final_checks"];
    const seen = new Set();

    for (let collection of collections) {
      const snap = await db.collection(collection).get();
      snap.forEach(doc => {
        const d = doc.data();
        const hrid = d.hrid;
        const date = new Date(d.createdAt?.seconds * 1000 || d.createdAt);
        if (!hrid || !date || isNaN(date)) return;

        const key = `${collection}_${hrid}`;
        if (seen.has(key)) return;
        seen.add(key);

        const period = getSixMonthPeriod(date);
        if (!statsResult[period]) {
          statsResult[period] = {
            initialOk: 0, initialRejected: 0,
            finalOk: 0, finalRejected: 0
          };
        }

        const status = d.status;
        if (collection === "initial_checks") {
          if (status === "Ok") statsResult[period].initialOk++;
          else if (status === "Rejected") statsResult[period].initialRejected++;
        } else if (collection === "final_checks") {
          if (status === "Ok") statsResult[period].finalOk++;
          else if (status === "Rejected") statsResult[period].finalRejected++;
        }
      });
    }

    // Populate dropdown
    const select = document.getElementById("periodSelect");
    select.innerHTML = "";
    const sortedPeriods = Object.keys(statsResult).sort();
    sortedPeriods.forEach(period => {
      const opt = document.createElement("option");
      opt.value = period;
      opt.textContent = period;
      select.appendChild(opt);
    });

    if (sortedPeriods.length > 0) {
      select.value = sortedPeriods[0];
      renderTable();
    }
  }

  function renderTable() {
    const tbody = document.querySelector("#statsTable tbody");
    tbody.innerHTML = "";

    const period = document.getElementById("periodSelect").value;
    if (!period || !statsResult[period]) {
      tbody.innerHTML = `<tr><td colspan="5">No data.</td></tr>`;
      return;
    }

    const r = statsResult[period];
    tbody.innerHTML = `
      <tr>
        <td>${period}</td>
        <td>${r.initialOk}</td>
        <td>${r.initialRejected}</td>
        <td>${r.finalOk}</td>
        <td>${r.finalRejected}</td>
      </tr>`;
  }

  function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const userEmail = firebase.auth().currentUser?.email || "Unknown";
    const today = new Date().toLocaleDateString("en-GB");
    const period = document.getElementById("periodSelect").value;
    const r = statsResult[period];

    // Header
    doc.setFont("Helvetica", "bold");
    doc.setFontSize(16);
    doc.text("KISR QA Statistics Report", 14, 20);

    // Metadata
    doc.setFontSize(11);
    doc.setFont("Helvetica", "normal");
    doc.text(`Generated by: ${userEmail}`, 14, 30);
    doc.text(`Generated on: ${today}`, 14, 36);

    // Disclaimer
    const note = `Note: This report includes only the first occurrence of each unique HRID.
If a report was initially rejected and later marked OK, only the first status is considered.
This ensures accuracy and avoids counting corrections as separate OK entries.`;

    doc.setFontSize(10);
    doc.text(doc.splitTextToSize(note, 180), 14, 46);

    // Table
    doc.autoTable({
      startY: 76,
      head: [['Period', 'Initial QA - OK', 'Initial QA - Rejected', 'Final QA - OK', 'Final QA - Rejected']],
      body: [[period, r.initialOk, r.initialRejected, r.finalOk, r.finalRejected]],
      theme: 'grid',
      styles: {
        font: "helvetica",
        fontSize: 10,
        cellPadding: 3,
      },
      headStyles: {
        fillColor: [50, 50, 50],
        textColor: 255,
        fontStyle: 'bold'
      },
      margin: { left: 14, right: 14 }
    });

    doc.setFontSize(9);
    doc.text("KISR â€” National Scientific and Technical Information Center (NSTIC)", 14, 285);
    doc.save(`kisr_qa_statistics_${period}.pdf`);
  }
</script>
</body>
</html>




