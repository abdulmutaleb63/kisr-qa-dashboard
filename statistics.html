<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KISR QA Statistics</title>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }
    .main-container {
      display: flex;
      min-height: 100vh;
    }
    #sidebar {
      width: 220px;
      border-right: 1px solid #ccc;
      padding: 20px;
      background-color: #f7f7f7;
    }
    .content {
      flex: 1;
      padding: 30px;
    }
    table {
      border-collapse: collapse;
      margin-top: 20px;
      width: 100%;
    }
    th, td {
      border: 1px solid #999;
      padding: 8px;
      text-align: left;
    }
    input, button {
      margin-right: 10px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div id="sidebar"></div>
    <div class="content">
      <h2>KISR QA Statistics (First Occurrence by HRID)</h2>

      <label>From: <input type="date" id="fromDate"></label>
      <label>To: <input type="date" id="toDate"></label>
      <button onclick="generateStats()">Generate Report</button>
      <button onclick="downloadPDF()">Download PDF</button>

      <table id="statsTable">
        <thead>
          <tr>
            <th>Period</th>
            <th>Initial QA - OK</th>
            <th>Initial QA - Rejected</th>
            <th>Final QA - OK</th>
            <th>Final QA - Rejected</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
  // Load sidebar
  fetch('sidebar.html')
    .then(res => res.text())
    .then(html => document.getElementById('sidebar').innerHTML = html);

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAvwfziFOkb-j0Hbc7Ff-MOBfxpNs7q2TI",
    authDomain: "kisr-qa-dashboard.firebaseapp.com",
    projectId: "kisr-qa-dashboard"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "index.html";
    }
  });

  function getSixMonthPeriod(date) {
    const d = new Date(date);
    const year = d.getFullYear();
    const month = d.getMonth();
    return month >= 9
      ? `${year}-Oct to ${year + 1}-Mar`
      : `${year - 1}-Oct to ${year}-Mar`;
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr);
    return isNaN(date.getTime()) ? null : date;
  }

  async function generateStats() {
    const fromDate = formatDate(document.getElementById("fromDate").value);
    const toDate = formatDate(document.getElementById("toDate").value);
    const tbody = document.querySelector("#statsTable tbody");
    tbody.innerHTML = "Loading...";

    const collections = ["initial_checks", "final_checks"];
    const result = {};

    for (let collection of collections) {
      const snap = await db.collection(collection).get();
      const seen = new Set();

      snap.forEach(doc => {
        const d = doc.data();
        const hrid = d.hrid;
        const date = new Date(d.createdAt?.seconds * 1000 || d.createdAt);

        if (!hrid || !date || isNaN(date)) return;
        if (fromDate && date < fromDate) return;
        if (toDate && date > toDate) return;

        const key = `${collection}_${hrid}`;
        if (seen.has(key)) return;
        seen.add(key);

        const period = getSixMonthPeriod(date);
        if (!result[period]) {
          result[period] = {
            initialOk: 0, initialRejected: 0,
            finalOk: 0, finalRejected: 0
          };
        }

        const status = d.status;
        if (collection === "initial_checks") {
          if (status === "Ok") result[period].initialOk++;
          else if (status === "Rejected") result[period].initialRejected++;
        } else if (collection === "final_checks") {
          if (status === "Ok") result[period].finalOk++;
          else if (status === "Rejected") result[period].finalRejected++;
        }
      });
    }

    tbody.innerHTML = "";
    const sortedPeriods = Object.keys(result).sort();
    sortedPeriods.forEach(period => {
      const r = result[period];
      tbody.innerHTML += `
        <tr>
          <td>${period}</td>
          <td>${r.initialOk}</td>
          <td>${r.initialRejected}</td>
          <td>${r.finalOk}</td>
          <td>${r.finalRejected}</td>
        </tr>`;
    });

    if (sortedPeriods.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5">No data in selected range.</td></tr>`;
    }
  }

  async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("KISR QA Statistics Report", 14, 16);

    const table = document.getElementById("statsTable");
    let y = 30;

    // Headers
    const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.innerText);
    doc.setFont("Helvetica", "bold");
    doc.text(headers.join(" | "), 14, y);
    y += 10;

    // Rows
    const rows = table.querySelectorAll("tbody tr");
    doc.setFont("Helvetica", "normal");
    rows.forEach(row => {
      const cols = Array.from(row.querySelectorAll("td")).map(td => td.innerText);
      doc.text(cols.join(" | "), 14, y);
      y += 10;
    });

    doc.save("kisr_qa_statistics.pdf");
  }
</script>
</body>
</html>



