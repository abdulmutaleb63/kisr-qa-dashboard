<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KISR QA Statistics</title>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="main-container">
    <div id="sidebar"></div>
    <div class="content">
      <h2>KISR QA Statistics (First Occurrence by HRID)</h2>

      <label>Period:
        <select id="periodSelect">
          <option value="2025-10-01_2026-03-31">2025 Oct–Mar</option>
          <option value="2026-04-01_2026-09-30">2026 Apr–Sep</option>
          <option value="2026-10-01_2027-03-31">2026 Oct–Mar</option>
          <option value="2027-04-01_2027-09-30">2027 Apr–Sep</option>
        </select>
      </label>
      <button onclick="generateStats()">Generate Report</button>
      <button onclick="downloadPDF()">Download PDF</button>

      <br><br>

      <table id="statsTable" border="1">
        <thead>
          <tr>
            <th>Period</th>
            <th>Initial QA - OK</th>
            <th>Initial QA - Rejected</th>
            <th>Final QA - OK</th>
            <th>Final QA - Rejected</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
  // Load sidebar
  fetch('sidebar.html')
    .then(res => res.text())
    .then(html => document.getElementById('sidebar').innerHTML = html);

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAvwfziFOkb-j0Hbc7Ff-MOBfxpNs7q2TI",
    authDomain: "kisr-qa-dashboard.firebaseapp.com",
    projectId: "kisr-qa-dashboard"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "index.html";
    }
  });

  async function generateStats() {
    const periodValue = document.getElementById("periodSelect").value;
    const [startStr, endStr] = periodValue.split("_");
    const fromDate = new Date(startStr);
    const toDate = new Date(endStr);
    const periodLabel = `${startStr.slice(0, 4)}-${new Date(startStr).toLocaleString('en', { month: 'short' })} to ${endStr.slice(0, 4)}-${new Date(endStr).toLocaleString('en', { month: 'short' })}`;

    const tbody = document.querySelector("#statsTable tbody");
    tbody.innerHTML = "Loading...";

    const collections = ["initial_checks", "final_checks"];
    const result = {
      [periodLabel]: {
        initialOk: 0, initialRejected: 0,
        finalOk: 0, finalRejected: 0
      }
    };

    for (let collection of collections) {
      const seen = new Set();
      const snap = await db.collection(collection).get();

      snap.forEach(doc => {
        const d = doc.data();
        const hrid = d.hrid;
        const date = new Date(d.createdAt?.seconds * 1000 || d.createdAt);

        if (!hrid || !date || isNaN(date)) return;
        if (date < fromDate || date > toDate) return;

        const key = `${collection}_${hrid}`;
        if (seen.has(key)) return;
        seen.add(key);

        const status = d.status;
        if (collection === "initial_checks") {
          if (status === "Ok") result[periodLabel].initialOk++;
          else if (status === "Rejected") result[periodLabel].initialRejected++;
        } else {
          if (status === "Ok") result[periodLabel].finalOk++;
          else if (status === "Rejected") result[periodLabel].finalRejected++;
        }
      });
    }

    tbody.innerHTML = "";
    const r = result[periodLabel];
    tbody.innerHTML += `
      <tr>
        <td>${periodLabel}</td>
        <td>${r.initialOk}</td>
        <td>${r.initialRejected}</td>
        <td>${r.finalOk}</td>
        <td>${r.finalRejected}</td>
      </tr>`;

    if (
      r.initialOk === 0 && r.initialRejected === 0 &&
      r.finalOk === 0 && r.finalRejected === 0
    ) {
      tbody.innerHTML = `<tr><td colspan="5">No data in selected period.</td></tr>`;
    }
  }

  async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("KISR QA Statistics Report", 14, 16);

    const table = document.getElementById("statsTable");
    let y = 30;

    // Headers
    const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.innerText);
    doc.setFont("Helvetica", "bold");
    doc.text(headers.join(" | "), 14, y);
    y += 10;

    // Rows
    const rows = table.querySelectorAll("tbody tr");
    doc.setFont("Helvetica", "normal");
    rows.forEach(row => {
      const cols = Array.from(row.querySelectorAll("td")).map(td => td.innerText);
      doc.text(cols.join(" | "), 14, y);
      y += 10;
    });

    doc.save("kisr_qa_statistics.pdf");
  }
</script>
</body>
</html>
