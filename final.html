<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Final QA Check</title>
  <link rel="stylesheet" href="css/final.css" />
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div id="container">
    <div id="sidebar"></div>
    <div id="main">
      <h2>Final QA ‚Äî Submission Form</h2>

      <form id="qaForm">
        <div class="form-row">
          <input type="text" id="hrid" placeholder="HRID" />
          <input type="text" id="cataloguer" placeholder="Cataloguer" />
        </div>
        <div class="form-row">
          <input type="date" id="dateIn" />
          <input type="text" id="errorFields" placeholder="Error fields (e.g. 245, 700)" />
        </div>
        <div class="form-row">
          <textarea id="errorDescription" placeholder="Error Description"></textarea>
        </div>
        <div class="form-row">
          <input type="date" id="dateOut" />
          <select id="status">
            <option value="Ok">Ok</option>
            <option value="Rejected">Rejected</option>
          </select>
          <input type="text" id="qa" placeholder="QA" />
        </div>
        <div class="form-row">
          <button type="button" id="submitBtn" onclick="submitEntry()">Submit</button>
          <button type="button" id="cancelBtn" onclick="cancelEdit()">Cancel</button>
        </div>
        <p id="msg"></p>
      </form>

      <h3>üìÑ Submitted Entries</h3>
      <table id="dataTable">
        <thead>
          <tr>
            <th>Entry No.</th>
            <th>HRID</th>
            <th>Cataloguer</th>
            <th>Date in</th>
            <th>Error fields</th>
            <th>Error Description</th>
            <th>Date Out</th>
            <th>Status</th>
            <th>QA</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    fetch("sidebar.html")
      .then(res => res.text())
      .then(html => document.getElementById("sidebar").innerHTML = html);

    const firebaseConfig = {
      apiKey: "AIzaSyAvwfziFOkb-j0Hbc7Ff-MOBfxpNs7q2TI",
      authDomain: "kisr-qa-dashboard.firebaseapp.com",
      projectId: "kisr-qa-dashboard"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let editingId = null;

    auth.onAuthStateChanged(user => {
      if (!user) window.location.href = "index.html";
      else loadEntries();
    });

    async function submitEntry() {
      const msg = document.getElementById("msg");
      const data = {
        hrid: document.getElementById("hrid").value.trim(),
        cataloguer: document.getElementById("cataloguer").value.trim(),
        dateIn: document.getElementById("dateIn").value,
        errorFields: document.getElementById("errorFields").value.trim(),
        errorDescription: document.getElementById("errorDescription").value.trim(),
        dateOut: document.getElementById("dateOut").value,
        status: document.getElementById("status").value,
        qa: document.getElementById("qa").value.trim()
      };

      try {
        if (editingId) {
          await db.collection("final_checks").doc(editingId).update(data);
          msg.textContent = "‚úÖ Entry updated!";
          editingId = null;
          document.getElementById("submitBtn").textContent = "Submit";
          document.getElementById("cancelBtn").style.display = "none";
        } else {
          await db.collection("final_checks").add({
            ...data,
            createdAt: new Date()
          });
          msg.textContent = "‚úÖ Entry added!";
        }
        clearForm();
        loadEntries();
      } catch (err) {
        msg.textContent = "‚ùå Error: " + err.message;
      }
    }

    function clearForm() {
      document.querySelectorAll("input, textarea, select").forEach(el => el.value = "");
    }

    async function loadEntries() {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      const snapshot = await db.collection("final_checks").orderBy("createdAt", "desc").limit(50).get();
      let count = 1;
      snapshot.forEach(doc => {
        const d = doc.data();
        const row = `
          <tr>
            <td>${count++}</td>
            <td>${d.hrid || ""}</td>
            <td>${d.cataloguer || ""}</td>
            <td>${d.dateIn || ""}</td>
            <td>${d.errorFields || ""}</td>
            <td>${d.errorDescription || ""}</td>
            <td>${d.dateOut || ""}</td>
            <td>${d.status || ""}</td>
            <td>${d.qa || ""}</td>
            <td class="actions">
              <button onclick="editEntry('${doc.id}')">‚úèÔ∏è</button>
              <button onclick="deleteEntry('${doc.id}')">üóëÔ∏è</button>
            </td>
          </tr>`;
        tbody.innerHTML += row;
      });
    }

    async function deleteEntry(id) {
      if (confirm("Are you sure you want to delete this entry?")) {
        await db.collection("final_checks").doc(id).delete();
        loadEntries();
      }
    }

    async function editEntry(id) {
      const doc = await db.collection("final_checks").doc(id).get();
      if (!doc.exists) return;

      const d = doc.data();
      document.getElementById("hrid").value = d.hrid || "";
      document.getElementById("cataloguer").value = d.cataloguer || "";
      document.getElementById("dateIn").value = d.dateIn || "";
      document.getElementById("errorFields").value = d.errorFields || "";
      document.getElementById("errorDescription").value = d.errorDescription || "";
      document.getElementById("dateOut").value = d.dateOut || "";
      document.getElementById("status").value = d.status || "Ok";
      document.getElementById("qa").value = d.qa || "";

      editingId = id;
      document.getElementById("submitBtn").textContent = "Update";
      document.getElementById("cancelBtn").style.display = "inline-block";
      document.getElementById("msg").textContent = "Editing entry...";
    }

    function cancelEdit() {
      editingId = null;
      clearForm();
      document.getElementById("submitBtn").textContent = "Submit";
      document.getElementById("cancelBtn").style.display = "none";
      document.getElementById("msg").textContent = "Edit cancelled.";
    }
  </script>
</body>
</html>







