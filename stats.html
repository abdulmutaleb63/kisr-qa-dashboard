<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KISR QA Monthly Summary</title>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px 10px; text-align: center; }
    th { background-color: #f5f5f5; }
    h2 { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>KISR QA Monthly Breakdown (Oct 2025 – Mar 2026)</h2>

  <table id="qaTable">
    <thead>
      <tr>
        <th rowspan="2">Done By</th>
        <th colspan="6">Initial Checks</th>
        <th rowspan="2">Total</th>
        <th colspan="6">Final Checks</th>
        <th rowspan="2">Total</th>
        <th rowspan="2">Grand Total</th>
      </tr>
      <tr>
        <th>Oct</th><th>Nov</th><th>Dec</th><th>Jan</th><th>Feb</th><th>Mar</th>
        <th>Oct</th><th>Nov</th><th>Dec</th><th>Jan</th><th>Feb</th><th>Mar</th>
      </tr>
    </thead>
    <tbody id="qaBody"></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAvwfziFOkb-j0Hbc7Ff-MOBfxpNs7q2TI",
      authDomain: "kisr-qa-dashboard.firebaseapp.com",
      projectId: "kisr-qa-dashboard"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const people = ["Mutaleb", "Aziz"];
    const months = ["Oct", "Nov", "Dec", "Jan", "Feb", "Mar"];
    const monthIndex = { Oct: 9, Nov: 10, Dec: 11, Jan: 0, Feb: 1, Mar: 2 };

    const start = new Date("2025-10-01");
    const end = new Date("2026-03-31");

    const counts = {};
    people.forEach(p => {
      counts[p] = {
        initial: [0, 0, 0, 0, 0, 0],
        final: [0, 0, 0, 0, 0, 0],
      };
    });

    Promise.all([
      db.collection("initial_checks").get(),
      db.collection("final_checks").get()
    ]).then(([initSnap, finalSnap]) => {
      initSnap.forEach(doc => processDoc(doc.data(), "initial"));
      finalSnap.forEach(doc => processDoc(doc.data(), "final"));
      renderTable();
    });

    function processDoc(data, type) {
      const name = data.doneBy;
      const rawDate = data.dateIn || data.createdAt;
      if (!name || !people.includes(name) || !rawDate) return;
      const date = new Date(rawDate.seconds ? rawDate.seconds * 1000 : rawDate);
      if (isNaN(date) || date < start || date > end) return;
      const m = date.getMonth();
      let index = -1;
      if (m >= 9) index = m - 9;       // Oct (9) to Dec (11) => index 0–2
      else index = m + 3;              // Jan (0) to Mar (2) => index 3–5
      if (index >= 0 && index <= 5) counts[name][type][index]++;
    }

    function renderTable() {
      const tbody = document.getElementById("qaBody");
      tbody.innerHTML = "";
      let grandTotal = 0;

      people.forEach(p => {
        const init = counts[p].initial;
        const fin = counts[p].final;
        const initTotal = init.reduce((a,b) => a + b, 0);
        const finTotal = fin.reduce((a,b) => a + b, 0);
        const total = initTotal + finTotal;
        grandTotal += total;

        let row = `<tr><td>${p}</td>`;
        init.forEach(v => row += `<td>${v}</td>`);
        row += `<td>${initTotal}</td>`;
        fin.forEach(v => row += `<td>${v}</td>`);
        row += `<td>${finTotal}</td><td>${total}</td></tr>`;
        tbody.innerHTML += row;
      });

      // Total row
      let totalRow = '<tr><th>Total</th>';
      for (let i = 0; i < 6; i++) {
        totalRow += `<th>${people.reduce((sum, p) => sum + counts[p].initial[i], 0)}</th>`;
      }
      const allInit = people.reduce((sum, p) => sum + counts[p].initial.reduce((a,b) => a + b, 0), 0);
      totalRow += `<th>${allInit}</th>`;
      for (let i = 0; i < 6; i++) {
        totalRow += `<th>${people.reduce((sum, p) => sum + counts[p].final[i], 0)}</th>`;
      }
      const allFinal = people.reduce((sum, p) => sum + counts[p].final.reduce((a,b) => a + b, 0), 0);
      totalRow += `<th>${allFinal}</th><th>${grandTotal}</th></tr>`;
      tbody.innerHTML += totalRow;
    }
  </script>
</body>
</html>
