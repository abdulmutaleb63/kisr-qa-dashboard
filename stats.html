<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QA Monthly Breakdown</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="css/stats.css">
  
</head>
<body>
  <div id="container">
    <div id="sidebar"></div>

    <div id="main">
      <h2>QA Monthly Breakdown (Oct 2025 â€“ Mar 2026)</h2>

      <div class="download-container">
        <button id="downloadBtn" onclick="downloadPDF()">Download PDF</button>
      </div>

      <table id="monthlyBreakdown">
        <thead>
          <tr>
            <th rowspan="2">Done By</th>
            <th colspan="6">Initial Checks</th>
            <th rowspan="2">Total</th>
            <th colspan="6">Final Checks</th>
            <th rowspan="2">Total</th>
            <th rowspan="2">Grand Total</th>
          </tr>
          <tr>
            <th>Oct</th><th>Nov</th><th>Dec</th><th>Jan</th><th>Feb</th><th>Mar</th>
            <th>Oct</th><th>Nov</th><th>Dec</th><th>Jan</th><th>Feb</th><th>Mar</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    fetch('sidebar.html')
      .then(res => res.text())
      .then(html => document.getElementById('sidebar').innerHTML = html);

    const firebaseConfig = {
      apiKey: "AIzaSyAvwfziFOkb-j0Hbc7Ff-MOBfxpNs7q2TI",
      authDomain: "kisr-qa-dashboard.firebaseapp.com",
      projectId: "kisr-qa-dashboard"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const months = ['Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar'];
    const cataloguers = ['Mutaleb', 'Aziz'];
    const collections = ['initial_checks', 'final_checks'];

    auth.onAuthStateChanged(async (user) => {
      if (!user) return window.location.href = "index.html";
      const tableBody = document.querySelector("#monthlyBreakdown tbody");

      const counts = {};
      cataloguers.forEach(name => {
        counts[name] = {
          initial: Array(6).fill(0),
          final: Array(6).fill(0)
        };
      });

      for (const collection of collections) {
        const snapshot = await db.collection(collection).get();
        snapshot.forEach(doc => {
          const data = doc.data();
          const who = data.qa;
          const dateInStr = data.dateIn;

          if (!who || !dateInStr || !cataloguers.includes(who)) return;

          const date = new Date(dateInStr);
          if (isNaN(date)) return;

          const year = date.getFullYear();
          const month = date.getMonth();

          let index = -1;
          if (year === 2025 && month >= 9) index = month - 9;
          if (year === 2026 && month <= 2) index = month + 3;
          if (index < 0 || index > 5) return;

          if (collection === 'initial_checks') counts[who].initial[index]++;
          else counts[who].final[index]++;
        });
      }

      cataloguers.forEach(name => {
        const init = counts[name].initial;
        const fin = counts[name].final;
        const totalInit = init.reduce((a, b) => a + b, 0);
        const totalFin = fin.reduce((a, b) => a + b, 0);
        const grand = totalInit + totalFin;

        let row = `<tr><td>${name}</td>`;
        row += init.map(n => `<td>${n}</td>`).join('');
        row += `<td>${totalInit}</td>`;
        row += fin.map(n => `<td>${n}</td>`).join('');
        row += `<td>${totalFin}</td>`;
        row += `<td>${grand}</td></tr>`;
        tableBody.innerHTML += row;
      });

      let totalRow = `<tr><td>Total</td>`;
      const initTotals = Array(6).fill(0);
      const finTotals = Array(6).fill(0);

      for (let i = 0; i < 6; i++) {
        initTotals[i] = cataloguers.reduce((sum, name) => sum + counts[name].initial[i], 0);
        totalRow += `<td>${initTotals[i]}</td>`;
      }
      const initTotalSum = initTotals.reduce((a, b) => a + b, 0);
      totalRow += `<td>${initTotalSum}</td>`;

      for (let i = 0; i < 6; i++) {
        finTotals[i] = cataloguers.reduce((sum, name) => sum + counts[name].final[i], 0);
        totalRow += `<td>${finTotals[i]}</td>`;
      }
      const finTotalSum = finTotals.reduce((a, b) => a + b, 0);
      totalRow += `<td>${finTotalSum}</td>`;
      totalRow += `<td>${initTotalSum + finTotalSum}</td></tr>`;

      tableBody.innerHTML += totalRow;
    });

async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l', 'mm', 'a4'); // Landscape orientation

  const element = document.querySelector('#monthlyBreakdown');

  // Scale table to fit within A4 width
  const canvas = await html2canvas(element, {
    scale: 2, // increases sharpness
    scrollX: 0,
    scrollY: -window.scrollY,
    windowWidth: document.documentElement.scrollWidth,
    useCORS: true
  });

  const imgData = canvas.toDataURL('image/png');
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const imgWidth = pageWidth - 20; // leave margin
  const imgHeight = (canvas.height * imgWidth) / canvas.width;

  doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
  doc.save('QA-Monthly-Breakdown.pdf');
}

      doc.save('QA-Monthly-Breakdown.pdf');
    }
  </script>
  <script src="js/common.js"></script>
</body>
</html>
