<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KISR QA Monthly Breakdown</title>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f5f5f5;
    }
  </style>
</head>
<body>
  <h2>KISR QA Monthly Breakdown (Oct 2025 – Mar 2026)</h2>
  <table id="monthlyBreakdown">
    <thead>
      <tr>
        <th rowspan="2">Done By</th>
        <th colspan="6">Initial Checks</th>
        <th rowspan="2">Total</th>
        <th colspan="6">Final Checks</th>
        <th rowspan="2">Total</th>
        <th rowspan="2">Grand Total</th>
      </tr>
      <tr>
        <th>Oct</th><th>Nov</th><th>Dec</th><th>Jan</th><th>Feb</th><th>Mar</th>
        <th>Oct</th><th>Nov</th><th>Dec</th><th>Jan</th><th>Feb</th><th>Mar</th>
      </tr>
    </thead>
    <tbody>
      <!-- Data rows will be inserted here -->
    </tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAvwfziFOkb-j0Hbc7Ff-MOBfxpNs7q2TI",
      authDomain: "kisr-qa-dashboard.firebaseapp.com",
      projectId: "kisr-qa-dashboard"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const months = ['Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar'];
    const monthIndexes = [9,10,11,0,1,2]; // JS month indexes

    auth.onAuthStateChanged(async (user) => {
      if (!user) return window.location.href = "index.html";
      const tableBody = document.querySelector("#monthlyBreakdown tbody");
      const cataloguers = ['Mutaleb', 'Aziz'];
      const collections = ['initial_checks', 'final_checks'];

      const counts = {};
      cataloguers.forEach(name => {
        counts[name] = {
          initial: Array(6).fill(0),
          final: Array(6).fill(0)
        };
      });

      const start = new Date('2025-10-01');
      const end = new Date('2026-03-31');

      for (const collection of collections) {
        const snap = await db.collection(collection).get();
        snap.forEach(doc => {
          const d = doc.data();
          const who = d.doneBy;
          const date = new Date(d.createdAt?.seconds * 1000 || d.createdAt);
          if (!who || !cataloguers.includes(who) || isNaN(date)) return;
          if (date < start || date > end) return;

          const year = date.getFullYear();
          const month = date.getMonth();

          let index = -1;
          if (year === 2025 && month >= 9) index = month - 9;  // Oct–Dec 2025
          if (year === 2026 && month <= 2) index = month + 3;  // Jan–Mar 2026
          if (index === -1) return;

          if (collection === 'initial_checks') counts[who].initial[index]++;
          if (collection === 'final_checks') counts[who].final[index]++;
        });
      }

      cataloguers.forEach(name => {
        const init = counts[name].initial;
        const fin = counts[name].final;
        const totalInit = init.reduce((a,b) => a+b, 0);
        const totalFin = fin.reduce((a,b) => a+b, 0);
        const grand = totalInit + totalFin;

        let row = `<tr><td>${name}</td>`;
        row += init.map(n => `<td>${n}</td>`).join('');
        row += `<td>${totalInit}</td>`;
        row += fin.map(n => `<td>${n}</td>`).join('');
        row += `<td>${totalFin}</td>`;
        row += `<td>${grand}</td></tr>`;
        tableBody.innerHTML += row;
      });

      // Totals row
      const totalRow = [`<td>Total</td>`];
      for (let i = 0; i < 6; i++) {
        const sumInit = cataloguers.reduce((sum, name) => sum + counts[name].initial[i], 0);
        totalRow.push(`<td>${sumInit}</td>`);
      }
      const totalInitAll = totalRow.slice(1).reduce((a,b) => a + parseInt(b.replace(/<[^>]+>/g, '')), 0);
      totalRow.push(`<td>${totalInitAll}</td>`);

      for (let i = 0; i < 6; i++) {
        const sumFin = cataloguers.reduce((sum, name) => sum + counts[name].final[i], 0);
        totalRow.push(`<td>${sumFin}</td>`);
      }
      const totalFinAll = totalRow.slice(8,14).reduce((a,b) => a + parseInt(b.replace(/<[^>]+>/g, '')), 0);
      totalRow.push(`<td>${totalFinAll}</td>`);
      totalRow.push(`<td>${totalInitAll + totalFinAll}</td>`);

      tableBody.innerHTML += `<tr>${totalRow.join('')}</tr>`;
    });
  </script>
</body>
</html>

